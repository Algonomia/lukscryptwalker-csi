image:
  repository: ghcr.io/algonomia/lukscryptwalker-csi
  tag: "v1.2.5"
  pullPolicy: IfNotPresent

# Image pull secrets
imagePullSecrets: []

# CSI Driver configuration
csiDriver:
  name: lukscryptwalker.csi.k8s.io
  attachRequired: false
  podInfoOnMount: true  # Enable to get pod fsGroup information

# Controller configuration
controller:
  replicas: 1
  
  # Sidecar images
  sidecars:
    provisioner:
      image:
        repository: registry.k8s.io/sig-storage/csi-provisioner
        tag: v3.6.2
        pullPolicy: IfNotPresent
    resizer:
      image:
        repository: registry.k8s.io/sig-storage/csi-resizer  
        tag: v1.9.2
        pullPolicy: IfNotPresent

  resources:
    limits:
      cpu: 200m
      memory: 256Mi
    requests:
      cpu: 100m
      memory: 128Mi

  nodeSelector: {}
  tolerations: []
  affinity: {}

# Node configuration
node:
  # Sidecar images
  sidecars:
    nodeDriverRegistrar:
      image:
        repository: registry.k8s.io/sig-storage/csi-node-driver-registrar
        tag: v2.9.2
        pullPolicy: IfNotPresent

  resources:
    limits:
      cpu: 500m
      memory: 1Gi
    requests:
      cpu: 100m
      memory: 256Mi

  nodeSelector: {}
  tolerations:
    - operator: Exists
  affinity: {}

# Storage configuration
storage:
  # Default local path for volumes (overrides hardcoded fallback)
  defaultPath: "/opt/local-path-provisioner"
  
  # Default size for backing files
  defaultSize: "1Gi"

# LUKS secret configuration (shared by all StorageClasses by default)
# WARNING: Setting passphrase in values.yaml is not secure for production!
# For production, create secrets manually and set create: false
secret:
  name: luks-secret
  namespace: kube-system
  # Auto-create secret with random passphrase
  create: true  # Set to false for production and create secret manually
  # If create is false, provide your own passphrase
  passphrase: ""  # WARNING: Not secure - use external secret management
  # Key name within the secret that contains the passphrase
  passphraseKey: "passphrase"

# StorageClasses configuration - all StorageClasses are defined here
storageClasses:
  # Default StorageClass with automatic fsGroup detection
  - name: lukscryptwalker-local
    isDefault: false
    reclaimPolicy: Delete
    allowVolumeExpansion: true
    volumeBindingMode: WaitForFirstConsumer
    # fsGroup: null  # Auto-detect from pod (default behavior)
    secret:
      name: luks-secret
      namespace: kube-system
      passphraseKey: "passphrase"
  
  # Example configurations for different database types
  # Uncomment and customize as needed
  
  # - name: lukscryptwalker-postgres
  #   isDefault: false
  #   reclaimPolicy: Delete
  #   allowVolumeExpansion: true
  #   volumeBindingMode: WaitForFirstConsumer
  #   fsGroup: 26  # PostgreSQL group
  #   secret:
  #     name: luks-secret
  #     namespace: kube-system
  #     passphraseKey: "passphrase"
  
  # - name: lukscryptwalker-mysql
  #   isDefault: false
  #   reclaimPolicy: Delete
  #   allowVolumeExpansion: true
  #   volumeBindingMode: WaitForFirstConsumer
  #   fsGroup: 999  # MySQL group
  #   secret:
  #     name: luks-secret
  #     namespace: kube-system
  #     passphraseKey: "passphrase"
  
  # - name: lukscryptwalker-custom
  #   isDefault: false
  #   reclaimPolicy: Delete
  #   allowVolumeExpansion: true
  #   volumeBindingMode: WaitForFirstConsumer
  #   fsGroup: 1001  # Custom application group
  #   secret:
  #     name: custom-luks-secret
  #     namespace: kube-system
  #     passphraseKey: "encryption-key"

# RBAC configuration
rbac:
  create: true

# ServiceAccount configuration  
serviceAccount:
  controller:
    create: true
    name: lukscryptwalker-csi-controller
    annotations: {}
  node:
    create: true
    name: lukscryptwalker-csi-node
    annotations: {}

# Security context
securityContext:
  # Controller runs as non-privileged
  controller:
    runAsNonRoot: true
    runAsUser: 1001
    runAsGroup: 1001
  # Node must run privileged for LUKS operations
  node:
    privileged: true
    runAsUser: 0
    runAsGroup: 0
    allowPrivilegeEscalation: true
    capabilities:
      add: ["SYS_ADMIN"]

# Pod security context (for pod-level settings like fsGroup)
podSecurityContext:
  controller: {}  # No fsGroup needed - directories are created with 0777 permissions
  node: {}

# Logging
logging:
  level: 4

# Node selector for deployment
nodeSelector: {}

# Tolerations
tolerations: []

# Pod annotations
podAnnotations: {}

# S3 Storage Classes configuration - rclone mount with encrypted S3 backend
s3StorageClasses:
  # Example S3 StorageClass with rclone mount
  - name: lukscryptwalker-s3
    isDefault: false
    reclaimPolicy: Delete
    allowVolumeExpansion: true
    volumeBindingMode: WaitForFirstConsumer
    fsType: "ext4"
    # fsGroup: null  # Auto-detect from pod

    # Encryption passphrase (rclone crypt uses NaCl SecretBox)
    secret:
      name: luks-secret
      namespace: kube-system
      passphraseKey: "passphrase"

    # S3 Configuration - all parameters stored in a single secret
    # WARNING: Setting credentials in values.yaml is not secure for production!
    # For production, create secrets manually and set create: false
    s3:
      # pathPrefix: "my-app/data"  # Optional: custom path in S3 (default: volumes/{volumeID}/files)
                                   # When set, this is also used as salt for encryption password2
                                   # Note: This is a StorageClass parameter, not stored in the secret
      secret:
        name: s3-credentials
        namespace: kube-system
        create: true  # Set to false for production and create secret manually
        # S3 bucket configuration
        bucket: "my-encrypted-volumes"
        region: "us-east-1"
        # endpoint: "https://s3.amazonaws.com"  # Optional: for S3-compatible services
        # forcePathStyle: false  # Set to true for MinIO and similar services
        # S3 credentials
        accessKeyId: ""  # WARNING: Not secure - use external secret management
        secretAccessKey: ""  # WARNING: Not secure - use external secret management

    # VFS Cache Configuration (rclone mount caches files locally in LUKS container)
    vfsCache:
      mode: "full"  # Options: off, minimal, writes, full
      maxAge: "1h"  # Max time to keep file in cache
      maxSize: "1G"  # Max total size of cache
      writeBack: "5s"  # Time to wait before uploading modified files

  # Example S3 StorageClass with minimal caching (saves local space)
  # - name: lukscryptwalker-s3-minimal
  #   isDefault: false
  #   reclaimPolicy: Delete
  #   allowVolumeExpansion: true
  #   volumeBindingMode: WaitForFirstConsumer
  #   fsType: "ext4"
  #
  #   secret:
  #     name: luks-secret
  #     namespace: kube-system
  #     passphraseKey: "passphrase"
  #
  #   s3:
  #     # pathPrefix: "backup/data"  # Optional: custom path in S3
  #     secret:
  #       name: s3-backup-credentials
  #       namespace: kube-system
  #       create: true  # WARNING: Not secure for production
  #       bucket: "my-backup-volumes"
  #       region: "us-west-2"
  #       accessKeyId: ""
  #       secretAccessKey: ""
  #
  #   vfsCache:
  #     mode: "minimal"  # Only cache open files
  #     maxAge: "30m"
  #     maxSize: "500M"

  # Example S3 StorageClass for OVH S3 with custom path
  # - name: lukscryptwalker-ovh
  #   isDefault: false
  #   reclaimPolicy: Delete
  #   allowVolumeExpansion: true
  #   volumeBindingMode: WaitForFirstConsumer
  #
  #   secret:
  #     name: luks-secret
  #     namespace: kube-system
  #     passphraseKey: "passphrase"
  #
  #   s3:
  #     pathPrefix: "my-app/data"  # Custom path - also used as encryption salt
  #     secret:
  #       name: ovh-s3-credentials
  #       namespace: kube-system
  #       create: true  # WARNING: Not secure for production
  #       bucket: "encrypted-volumes"
  #       region: "gra"  # GRA, SBG, DE, UK, etc.
  #       endpoint: "https://s3.gra.cloud.ovh.net"
  #       forcePathStyle: false
  #       accessKeyId: ""
  #       secretAccessKey: ""
  #
  #   vfsCache:
  #     mode: "full"
  #     maxAge: "2h"
  #     maxSize: "2G"
  #     writeBack: "10s"
