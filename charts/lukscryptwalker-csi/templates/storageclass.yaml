{{- if .Values.secret.create }}
---
apiVersion: v1
kind: Secret
metadata:
  name: {{ .Values.secret.name }}
  namespace: {{ .Values.secret.namespace }}
  labels:
    {{- include "lukscryptwalker-csi.labels" . | nindent 4 }}
type: Opaque
data:
  {{- if .Values.secret.passphrase }}
  {{ .Values.secret.passphraseKey }}: {{ .Values.secret.passphrase | b64enc | quote }}
  {{- else }}
  # Auto-generated passphrase (base64 encoded)
  {{ .Values.secret.passphraseKey }}: {{ randAlphaNum 32 | b64enc | quote }}
  {{- end }}
{{- end }}

{{- range .Values.storageClasses }}
{{- $existingStorageClass := lookup "storage.k8s.io/v1" "StorageClass" "" .name }}
{{- if $existingStorageClass }}
{{- if $.Values.debug }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .name }}-exists-warning
  namespace: {{ $.Release.Namespace }}
  labels:
    {{- include "lukscryptwalker-csi.labels" $ | nindent 4 }}
  annotations:
    "helm.sh/hook": pre-upgrade,pre-install
    "helm.sh/hook-weight": "-1"
data:
  warning: |
    WARNING: StorageClass '{{ .name }}' already exists and will be preserved.
    Existing PVCs using this StorageClass will continue to work.
    To update StorageClass parameters, you must delete it manually first.
{{- end }}
{{- else }}
---
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: {{ .name }}
  labels:
    {{- include "lukscryptwalker-csi.labels" $ | nindent 4 }}
  {{- if .isDefault }}
  annotations:
    storageclass.kubernetes.io/is-default-class: "true"
  {{- end }}
provisioner: {{ $.Values.csiDriver.name }}
parameters:
  # LUKS encryption parameters
  csi.storage.k8s.io/node-stage-secret-name: {{ .secret.name | quote }}
  csi.storage.k8s.io/node-stage-secret-namespace: {{ .secret.namespace | quote }}

  # Key name within the secret that contains the passphrase
  passphraseKey: {{ .secret.passphraseKey | quote }}

  {{- if .fsGroup }}
  # Manual fsGroup override for this StorageClass
  fsGroup: {{ .fsGroup | quote }}
  {{- end }}

reclaimPolicy: {{ .reclaimPolicy | default "Delete" }}
allowVolumeExpansion: {{ .allowVolumeExpansion | default true }}
volumeBindingMode: {{ .volumeBindingMode | default "WaitForFirstConsumer" }}
{{- end }}
{{- end }}